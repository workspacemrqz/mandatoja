# Guia de Conexão com WAHA (WhatsApp HTTP API)

Este documento descreve o fluxo completo de conexão com a WAHA, desde a criação da instância até a autenticação via QR-CODE.

---

## 1. Processo de Conexão com a Instância

A conexão com a WAHA segue um fluxo sequencial de quatro etapas principais:

1. **Inicialização do servidor WAHA** - O servidor deve estar em execução
2. **Criação da sessão/instância** - Uma nova sessão é criada via API
3. **Início da sessão** - A sessão criada é iniciada
4. **Autenticação via QR-CODE** - O usuário escaneia o QR-CODE com o WhatsApp

### Pré-requisitos

- Servidor WAHA em execução (padrão: `http://localhost:3000`)
- Acesso à API REST do WAHA
- Aplicativo WhatsApp instalado no celular para escanear o QR-CODE

---

## 2. Como Criar uma Nova Instância

Para criar uma nova instância (sessão) no WAHA, utilize o endpoint de criação de sessões.

### Endpoint

```
POST /api/sessions
```

### Corpo da Requisição

```json
{
  "name": "nome-da-sessao"
}
```

### Exemplo com cURL

```bash
curl -X POST http://localhost:3000/api/sessions \
  -H "Content-Type: application/json" \
  -d '{"name": "minha-instancia"}'
```

### Exemplo com Configurações Adicionais (Webhooks)

```json
{
  "name": "minha-instancia",
  "config": {
    "webhooks": [
      {
        "url": "https://seu-servidor.com/webhook",
        "events": ["message"]
      }
    ]
  }
}
```

### Resposta Esperada

Após a criação bem-sucedida, a API retorna os dados da sessão criada com status `STOPPED`.

---

## 3. Como Conectar à Instância Criada

Após criar a instância, é necessário iniciá-la para estabelecer a conexão.

### Endpoint

```
POST /api/sessions/{nome-da-sessao}/start
```

### Exemplo com cURL

```bash
curl -X POST http://localhost:3000/api/sessions/minha-instancia/start \
  -H "Content-Type: application/json" \
  -d '{}'
```

### Estados da Sessão

Após iniciar a sessão, ela passará pelos seguintes estados:

| Estado | Descrição |
|--------|-----------|
| `STOPPED` | Sessão parada |
| `STARTING` | Sessão em inicialização |
| `SCAN_QR_CODE` | Aguardando escaneamento do QR-CODE |
| `WORKING` | Sessão autenticada e funcionando |
| `FAILED` | Falha na sessão (requer reautenticação) |

### Verificar Status da Sessão

Para verificar o status atual da sessão:

```
GET /api/sessions/{nome-da-sessao}
```

```bash
curl http://localhost:3000/api/sessions/minha-instancia
```

---

## 4. Procedimento para Exibir a Imagem do QR-CODE

Quando a sessão estiver no estado `SCAN_QR_CODE`, é possível obter o QR-CODE para autenticação.

### Método 1: Imagem Direta

Retorna a imagem do QR-CODE diretamente.

```
GET /api/{nome-da-sessao}/auth/qr
```

```bash
curl http://localhost:3000/api/minha-instancia/auth/qr --output qrcode.png
```

### Método 2: Formato Base64 (JSON)

Retorna o QR-CODE em formato Base64 dentro de um JSON.

```bash
curl -H "Accept: application/json" http://localhost:3000/api/minha-instancia/auth/qr
```

### Método 3: Dados Brutos

Retorna os dados brutos do QR-CODE para geração própria.

```
GET /api/{nome-da-sessao}/auth/qr?format=raw
```

```bash
curl http://localhost:3000/api/minha-instancia/auth/qr?format=raw
```

### Método 4: Screenshot da Tela

Retorna um screenshot da tela do WhatsApp Web mostrando o QR-CODE.

```
GET /api/screenshot
```

```bash
curl http://localhost:3000/api/screenshot --output screenshot.png
```

### Processo de Escaneamento

1. Obtenha o QR-CODE utilizando um dos métodos acima
2. Abra o aplicativo WhatsApp no celular
3. Acesse **Configurações > Aparelhos Conectados > Conectar um Aparelho**
4. Escaneie o QR-CODE exibido
5. Aguarde a sessão mudar para o estado `WORKING`

### Observações Importantes

- Aguarde de 3 a 5 segundos após iniciar a sessão antes de solicitar o QR-CODE
- O QR-CODE é atualizado automaticamente pelo WhatsApp; faça polling do endpoint caso expire
- Quando o status da sessão mudar para `WORKING`, a autenticação foi concluída com sucesso

---

## Fluxo Completo de Conexão

Resumo sequencial de todos os comandos:

```bash
# 1. Criar a instância
curl -X POST http://localhost:3000/api/sessions \
  -H "Content-Type: application/json" \
  -d '{"name": "minha-instancia"}'

# 2. Iniciar a sessão
curl -X POST http://localhost:3000/api/sessions/minha-instancia/start \
  -H "Content-Type: application/json" \
  -d '{}'

# 3. Aguardar alguns segundos e obter o QR-CODE
curl http://localhost:3000/api/minha-instancia/auth/qr --output qrcode.png

# 4. Escanear o QR-CODE com o WhatsApp

# 5. Verificar se a sessão está autenticada
curl http://localhost:3000/api/sessions/minha-instancia
```
